@page "/MyPage"
@inject IUserService UserService
@inject ISessionService SessionService

<PageTitle>Min Profil</PageTitle>

@if (user == null)
{
    <p>Indlæser profil...</p>
}
else
{
    <div class="profile-container">
        <h2>Hej @user.Name, her er din profil</h2>
        @if (showAlert)
        {
            <div class="alert @alertClass">@alertText</div>
        }
        <div class="profile-info">
            <label>Brugernavn:</label>
            <input @bind="user.Name" />

            <label>Email:</label>
            <input value="@user.Email" disabled/>

            <label>Opdater password:</label>
            <div class="password-field"><!--@bind="user.Password" fjernet fra input som start til opdatere--> 
                <input type="@passwordFieldType"  />
                <button type="button" class="toggle-btn" @onclick="TogglePassword">
                    @(passwordFieldType == "password" ? "Vis" : "Skjul")
                </button>
            </div>

            <div class="stats">
                <p><strong>Antal sessioner:</strong> @sessionCount</p>
                <p><strong>Samlet antal sushi-stykker:</strong> @totalCount</p>
            </div>

            <button class="save-btn" @onclick="SaveChanges">Gem ændringer</button>
            <button type="button" @onclick="MoinMoinUser" class="btn btn-danger">Slet profil</button>
        </div>
    </div>

    <SletUserModal Visible="@visible" OnCloseRequested="@(() => visible = false)" UserToDelete="@user" />
}

@code {
    private User? user;
    private int sessionCount = 0;
    private int totalCount = 0;
    private string passwordFieldType = "password";
    private bool showAlert = false;
    private string alertText = "";
    private string alertClass = "";
    private bool visible = false;

    protected override async Task OnInitializedAsync()
    {
        user = await UserService.GetUserLoggedInAsync();

        if (user?.UserId is not null)
        {
            // HENT sessioner fra backend i stedet for at bruge user.Sessions
            var mySessions = await SessionService.GetMySessionsAsync(user.UserId);

            sessionCount = mySessions.Count;

            totalCount = mySessions
                .SelectMany(s => s.Participants ?? new List<Participant>())
                .Where(p => p.UserId == user.UserId)
                .Sum(p => p.Count);
        }
    }

    private void TogglePassword()
        => passwordFieldType = passwordFieldType == "password" ? "text" : "password";

    private Task MoinMoinUser()
    {
        visible = true;
        return Task.CompletedTask;
    }

    private async Task SaveChanges()
    {
        if (user == null) return;

        try
        {
            await UserService.UpdateUser(user);
            alertText = "Ændringer gemt!";
            alertClass = "ok";
        }
        catch (HttpRequestException ex)
        {
            alertText = ex.Message;
            alertClass = "err";
        }
        catch
        {
            alertText = "Der opstod en fejl under opdateringen.";
            alertClass = "err";
        }

        showAlert = true;
        StateHasChanged();
        await Task.Delay(2000);
        showAlert = false;
        StateHasChanged();
    }
}
