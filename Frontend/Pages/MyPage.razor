@page "/MyPage"
@inject IUserService UserService
@inject NavigationManager Nav
<PageTitle>Min Profil</PageTitle>

@if (user == null)
{
    <p>Indlæser profil...</p>
}
else
{
    <div class="profile-container">
        <h2>Hej @user.Name, her er din profil</h2>
        @if (showAlert)
        {
            <div class="alert @alertClass">@alertText</div>
        }
        <div class="profile-info">
            <label>Brugernavn:</label>
            <input @bind="user.Name"/>

            <label>Email:</label>
            <input value="@user.Email" disabled/>

            <label>Password:</label>
            <div class="password-field">
                <input type="@passwordFieldType" @bind="user.Password"/>
                <button type="button" class="toggle-btn" @onclick="TogglePassword">
                    @(passwordFieldType == "password" ? "Vis" : "Skjul")
                </button>
            </div>

            <div class="stats">
                <p><strong>Antal sessioner:</strong> @sessionCount</p>
                <p><strong>Samlet antal sushi-stykker:</strong> @totalCount</p>
            </div>

            <button class="save-btn" @onclick="SaveChanges">Gem ændringer</button>
            <button type="button" @onclick="MoinMoinUser" class="btn btn-danger">Slet profil</button>
        </div>

    </div>

    <SletUserModal Visible="@visible" OnCloseRequested="@(() => visible = false)" UserToDelete="@user"/>


@code {
    private User? user;
    private int sessionCount = 0;
    private int totalCount = 0;
    private string passwordFieldType = "password";
    private bool showAlert = false;
    private string alertText = "";
    private string alertClass = "";
    private bool visible = false;

    protected override async Task OnInitializedAsync()
    {
        user = await UserService.GetUserLoggedInAsync();
        if (user != null)
        {
            sessionCount = user.Sessions?.Count ?? 0;

            totalCount = user.Sessions == null
                ? 0
                : user.Sessions
                    .SelectMany(s => s.Participants ?? new List<Participant>())
                    .Where(p => p.UserId == user.UserId)
                    .Sum(p => p.Count);
        }
    }

    private void TogglePassword()
    {
        passwordFieldType = passwordFieldType == "password" ? "text" : "password";
    }

    private async Task MoinMoinUser()
    {
            //Visible bool er om modal skal vises eller ej, sættes derfor til true ved "OpenDeleteModal"
            visible = true;
        
    }

    private async Task SaveChanges()
    {
        if (user == null) return;

        try
        {
            await UserService.UpdateUser(user);
            alertText = "Ændringer gemt!";
            alertClass = "ok";
        }
        catch (HttpRequestException ex)
        {
            alertText = ex.Message; // fx “Brugernavnet er allerede valgt.”
            alertClass = "err";
        }
        catch
        {
            alertText = "Der opstod en fejl under opdateringen.";
            alertClass = "err";
        }


        showAlert = true;
        StateHasChanged(); // vis beskeden med det samme
        await Task.Delay(2000);
        showAlert = false;
        StateHasChanged(); // skjul beskeden igen
    }
}
}
