@page "/SushiCounter"
@inject IParticipantService ParticipantService
@inject IUserService UserService


<PageTitle>Counter</PageTitle>

<div class="counter-wrap">
    <h1>Counter</h1>

    <p class="status" role="status">Current count: <span class="count">@currentCount</span></p>
    <div class="sushi-display">
        <div id="@($"sushi{sushiIndex}")" class="sushi" @onclick="IncrementCount" title="Klik for +1">
            <div class="nori"></div>
            <div class="rice"></div>
            <div class="filling"></div>
            <div class="topping"></div>
            <div class="band"></div>
        </div>
    </div>

    <div class="btn-row">
        <button class="btn btn-secondary"@onclick="ResetCount" >Nulstil count</button>
        <button class="btn btn-primary" @onclick="IncrementCount">Click me</button>
        <button class="btn btn-secondary" @onclick="AddToSession">Tilføj til en session</button>
    </div>
    
</div>
<CountToSession Visible="@modalVisible"
                    CurrentUserId="@currentUserId"
                    OnClose="@(() => modalVisible = false)"
                    OnCommitted="@OnCommitted" />

@code {
    private int sushiIndex = 1;
    private const int totalSushi = 20; //Mhp at styre antallet af forskellige sushi billeder til fremtidig opgradering
    private bool modalVisible = false;
    private string? currentUserId;
    int currentCount = 0;

    protected override async Task OnInitializedAsync()
    {
        var u = await UserService.GetUserLoggedInAsync();
        currentUserId = u?.UserId;

        // Hent eksisterende værdi fra localStorage via servicen
        currentCount = await ParticipantService.GetCurrentLocalCountAsync();
    }
    private async Task ResetCount()
    {
        // Nulstil count i localStorage via servicen og opdater UI
        currentCount = await ParticipantService.ResetLocalCountAsync();
    }
    private async Task IncrementCount()
    {
        // Gemmer +1 i localStorage via servicen og opdaterer UI med den nye total
        currentCount = await ParticipantService.AddCountToSessionAsync(1);
        sushiIndex = (sushiIndex % totalSushi) + 1;
    }

    private Task AddToSession()
    {
        // Åbn modal – selve commit/reset sker i modal/servicen
        modalVisible = true;
        return Task.CompletedTask;
    }

    private Task OnCommitted()
    {
        // UI reset efter at service har nulstillet storage
        currentCount = 0;
        modalVisible = false;
        StateHasChanged();
        return Task.CompletedTask;
    }
}
